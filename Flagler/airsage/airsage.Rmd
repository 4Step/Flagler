---
title: "Flagler Data Review"
author: "Amar Sarvepalli"
date: "September 27, 2016"
output: html_document
---
```{r, echo = TRUE}
# User inputs:
projDir         <- "/Volumes/C/projects/Flagler/airsage"
airsage_data    <- c("trip_leg_matrix_cusWDH.csv",
                      "trip_leg_matrix_cusWDDP.csv",
                      "trip_leg_submatrix_cusWDDP.csv",
                      "trip_leg_submatrix_cusWDH.csv")
airsage_shapeFile <- "airsarge_districts/TAZs.shp"
airsage_Districts <- "airsarge_districts/Renumber2.txt"
acs_shapeFile     <- 
  
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# load libraries
library(tidyr)
library(dplyr)
library(knitr)
library(leaflet)
library(rgdal)
library(htmltools)
library(readr)

library(chorddiag)

# Used for computing district centroids
library(maptools)    # SpatialPolygons2PolySet
library(PBSmapping)  # calcCentroid
library(geosphere)

setwd(projDir)
```


## 1. Review of AirSage Data
This memo is divided into following sections:

1) Airsage Data Files
2) Review of Data: high level summaries
3) Plot of OD zones and corridor
4) Census socio-economic data
5) Plot of current corridor bus routes


#### 1.1 Airsage Data File Description
This is airsage data review. The following is the description of the data files

1) **trip_leg_matrix_cusWDH.csv**  and **trip_leg_matrix_cusWDDP.csv**: reporting  trips between study area zones for average weekday 24 hour period and specific AM and PM day parts respectively.

2) **trip_leg_submatrix_cusWDH.csv**  and **trip_leg_submatrix_cusWDDP.csv**: reporting trips between study area zones that passed through the sub matrix analysis zone (in the SZCount column) for average weekday 24 hour period and specific AM and PM day parts respectively. 

The following are the list of files received from Airsage along with:
1) number of samples
2) number of trips
3) ratio of trips to samples
4) percent of samples
5) percent of trips

```{r read data, echo=FALSE, message=FALSE, warning=FALSE}
  csvFiles <- dir(projDir, pattern = ".csv")

  for (c in 1:length(csvFiles)){
    data <- read.csv(csvFiles[c])
    nrows <- nrow(data)
    ntrips <- sum(data$Count)
    samples <- cbind(csvFiles[c], nrows, ntrips)
    ifelse (c ==1 , all_samples <- samples, all_samples <- rbind(all_samples, samples))
    ifelse (c ==1 , count <- nrows, count <- count + nrows)
    ifelse (c ==1 , trips <- ntrips, trips <- trips + ntrips)
  }

    all <- data.frame(all_samples, stringsAsFactors = FALSE)
    all <- rbind(all, c("Total",count, trips))
    all <- all %>% mutate(trip_per_sample = 100 * as.numeric(ntrips) / as.numeric(nrows))
    all <- all %>% mutate(pct_samples = 100 * as.numeric(nrows) / count)
    all <- all %>% mutate(pct_trips = 100 * as.numeric(ntrips) / trips)
    names(all) <- c("File", "Samples", "Trips","Trips/Samples" ,"% Sample", "% Trips")
    print(kable(all))
```

Peak data flow shows a total observations of 9,666 whereas total daily flows are only 6,052. 
Does this mean the daily samples are only for offpeak? 
46% of the daily flow are represented from 24% sample?


#### 1.2 Contents of "trip_leg_matrix_cusWDDP.csv" and Contents of "trip_leg_matrix_cusWDDP.csv"
This file contains 9,666 observations and 9 fields. Each sample was geocoded with an _Origin_Zone_ and _Destination_Zone_ pairs and _Count_ represents the total flows betweent these OD pairs. The start and end dates define the data collection period, which is April, 2015. The other fields: _Subscriber_Class_, _Purpose_ and _Time_of_Day_ describe the trip attributes.

```{r trips, echo=TRUE, message=FALSE, warning=FALSE}
  data_wddp <- read.csv("trip_leg_matrix_cusWDDP.csv")
  data_wdh <- read.csv("trip_leg_matrix_cusWDH.csv")
  data_wddp$tod <- "peak"
  data_wdh$tod <- "24H"
  data <- rbind(data_wddp, data_wdh)
  print(head(data))
  
  samples <- data %>% group_by(tod) %>% summarize(sum = sum(Count))
  samples <- data.frame(samples)
  kable(samples)
```

#### 1.3 Contents of Daily file (_trip_leg_matrix_cusWDH.csv_)
#### Trips by purpose and resident type (Subscriber_Class)
* There are a total of 7,457,084 OD flows in 24H. 
* About 83% of these trips (6.2 Million daily flows) are made by resident pouplation and the remaining 17% of trip are made by the visitors. 
* Most of the visitor trip purpose was Non-home based (NHB) as expected, however there are few handful of trips that are coded as Home-based other (HBO) trips (0.03%). These trips can be recoded into NHB as it makes less sense to assume a "home end" for visitors.
* Of 6.2 Million resident trips, 17% are Home-based work (HBW), 29% are NHB and 36% are HBO trips. The work share of trips is in acceptable range for HBW trips (typically ~20%).


```{r daily trips, echo=FALSE, message=FALSE, warning=FALSE}

  trips_by_type    <- data_wdh %>% group_by(Subscriber_Class) %>% 
                      summarise(trips = sum(Count)) %>% arrange(Subscriber_Class)
  trips_by_purpose <- data_wdh %>% group_by(Subscriber_Class, Purpose) %>% 
                      summarise(trips = sum(Count)) %>% arrange(Subscriber_Class)
  trips_by_OD      <- data_wdh %>% group_by(Origin_Zone, Destination_Zone) %>% 
                      summarise(trips = sum(Count)) %>% spread(Destination_Zone, trips)

  # Total trips  
  sum <- trips_by_type %>% summarise(total = sum(trips))
  print(paste("Total trips = ", as.character(sum), sep =""))
  
  # Compute percentage
  trips_by_type    <- trips_by_type %>%  mutate(percent = 100 * trips/sum$total)
  trips_by_purpose <- trips_by_purpose %>% mutate(percent = 100 * trips/sum(sum$total))
  
  # Print summary
  kable(trips_by_type)
  kable(trips_by_purpose)
  
  # District to district flows (limit this to Flagler districts)
  trips_by_OD <- trips_by_OD[,2:41]
  trips_by_OD[is.na(trips_by_OD)] <- 0
  m <- as.matrix(trips_by_OD)
  dist <- c(1:40)
  dimnames(m) <- list(Origins = dist,Destinations = dist)
  groupColors <- colors()[dist]
  chorddiag(m, groupColors = groupColors, groupnamePadding = 20)

```

#### 1.4 Contents of Peak period files (_trip_leg_matrix_cusWDDP.csv_)
#### Trips by purpose, resident type (Subscriber_Class) and time of day
* There are a total of 2,945,178 OD flows in the peak two periods. 
* About 85% of these trips (2.5 Million flows) are made by resident pouplation and the remaining 15% of trip are made by the visitors. 
* Most of the visitor trip purpose was Non-home based (NHB) as expected, however there are few handful of trips that are coded as Home-based other (HBO) trips (0.02%). These trips can be recoded into NHB as it makes less sense to assume a "home end" for visitors.
* Of 2.5 Million resident trips, 21% are Home-based work (HBW), 29% are NHB and 34% are HBO trips. The non-work share of trips seems too high given this file contains data only for the 6 hour peak periods.
* Trips by time of day shows almost equal split between AM and PM peak periods with slightly more trips in PM period.

```{r, echo = FALSE}
  trips_by_type    <- data_wddp %>% group_by(Subscriber_Class) %>% 
                      summarise(trips = sum(Count)) %>% arrange(Subscriber_Class)
  trips_by_purpose <- data_wddp %>% group_by(Subscriber_Class, Purpose) %>% 
                      summarise(trips = sum(Count)) %>% arrange(Subscriber_Class)
  trips_by_period  <- data_wddp %>% group_by(Time_of_Day) %>% 
                      summarise(trips = sum(Count)) %>% arrange(Time_of_Day)
  trips_by_OD      <- data_wddp %>% group_by(Origin_Zone, Destination_Zone) %>% 
                      summarise(trips = sum(Count)) %>% spread(Destination_Zone, trips)

  # Total trips
  sum <- trips_by_type %>% summarise(total = sum(trips))
  print(paste("Total trips = ", as.character(sum), sep =""))
  
  # Compute percentage
  trips_by_type    <- trips_by_type %>%  mutate(percent = 100 * trips/sum$total)
  trips_by_purpose <- trips_by_purpose %>% mutate(percent = 100 * trips/sum(sum$total))
  trips_by_period  <- trips_by_period %>% mutate(percent = 100 * trips/sum(sum$total))
  
  # Print summary
  kable(trips_by_type)
  kable(trips_by_purpose)
  kable(trips_by_period)
  
  # District to district flows (limit this to Flagler districts)
  trips_by_OD <- trips_by_OD[,2:41]
  trips_by_OD[is.na(trips_by_OD)] <- 0
  m <- as.matrix(trips_by_OD)
  dist <- c(1:40)
  dimnames(m) <- list(Origins = dist,Destinations = dist)
  groupColors <- colors()[dist]
  chorddiag(m, groupColors = groupColors, groupnamePadding = 20)

```

#### 1.5 Contents of Peak subarea files (_trip_leg_submatrix_cusWDDP.csv_)
#### Trips by purpose, resident type (Subscriber_Class) and time of day
* There are a total of 1,472,307 OD flows in this file which represent EE flows through the region (Not sure I fully flow this file - Need some explaination from Airsage)
* About 83% of these trips (1.2 Million flows) are made by resident pouplation and the remaining 17% of trip are made by the visitors. 
* 10% of these trips are External-External through trips (ee). This is computed based on _SZCount_ field in the data.
* The share of ee trips by purpose is consistent across all resident purposes and time of day.
* Most of the visitor trip purpose was Non-home based (NHB) as expected.


```{r sub_ee_peak, echo=FALSE}
  sub_wddp <- read.csv("trip_leg_submatrix_cusWDDP.csv")
  trips_by_type    <- sub_wddp %>% group_by(Subscriber_Class) %>% 
                      summarise(trips = sum(Count), ee = sum(SZCount)) %>% arrange(Subscriber_Class)
  trips_by_purpose <- sub_wddp %>% group_by(Subscriber_Class, Purpose) %>% 
                      summarise(trips = sum(Count), ee = sum(SZCount)) %>% arrange(Subscriber_Class)
  trips_by_period  <- sub_wddp %>% group_by(Time_of_Day) %>% 
                      summarise(trips = sum(Count), ee = sum(SZCount)) %>% arrange(Time_of_Day)
  trips_by_OD      <- sub_wddp %>% group_by(Origin_Zone, Destination_Zone) %>% 
                      summarise(trips = sum(Count)) %>% spread(Destination_Zone, trips)

  # Total trips
  sum <- trips_by_type %>% summarise(total = sum(trips))
  ee_sum <- trips_by_type %>% summarise(total = sum(ee))
  print(paste("Total trips = ", as.character(sum), sep =""))
  
  # Compute percentage
  trips_by_type <- trips_by_type %>%  mutate(pct_trips = 100 * trips/sum$total, 
                                             pct_ee = 100 * ee/ee_sum$total, 
                                             ee_share = 100 * ee/trips)
  
  trips_by_purpose <- trips_by_purpose %>% mutate(pct_trips = 100 * trips/sum(sum$total), 
                                             pct_ee = 100 * ee/ee_sum$total, 
                                             ee_share = 100 * ee/trips)
  
  trips_by_period <- trips_by_period %>% mutate(pct_trips = 100 * trips/sum(sum$total), 
                                             pct_ee = 100 * ee/ee_sum$total, 
                                             ee_share = 100 * ee/trips)
  
  # Print summary
  kable(trips_by_type)
  kable(trips_by_purpose)
  kable(trips_by_period)
  
```


#### 1.6 Contents of Peak subarea files (_trip_leg_submatrix_cusWDH.csv_)
#### Trips by purpose, and resident type (Subscriber_Class) 
* There are a total of 4,001,471 OD flows in this file which represent EE flows through the region (Not sure I fully flow this file - Need some explaination from Airsage)
* About 80% of these trips (2.9 Million flows) are made by resident pouplation and the remaining 20% of trip are made by the visitors. 
* About 9% of these trips are External-External through trips (ee). This is computed based on _SZCount_ field in the data.
* The share of ee trips by purpose is consistent across all resident purposes and time of day.
* Most of the visitor trip purpose was Non-home based (NHB) as expected.


```{r sub_ee_daily, echo=FALSE}
  sub_wdh <- read.csv("trip_leg_submatrix_cusWDH.csv")

  # fix colnames for purpose and time_of_day
  sub_wdh <- sub_wdh %>% rename(Purpose = Time_of_Day, Time_of_Day = Purpose)

  trips_by_type    <- sub_wdh %>% group_by(Subscriber_Class) %>% 
                      summarise(trips = sum(Count), ee = sum(SZCount)) %>% arrange(Subscriber_Class)
  trips_by_purpose <- sub_wdh %>% group_by(Subscriber_Class, Purpose) %>% 
                      summarise(trips = sum(Count), ee = sum(SZCount)) %>% arrange(Subscriber_Class)
  trips_by_period  <- sub_wdh %>% group_by(Time_of_Day) %>% 
                      summarise(trips = sum(Count), ee = sum(SZCount)) %>% arrange(Time_of_Day)
  trips_by_OD      <- sub_wdh %>% group_by(Origin_Zone, Destination_Zone) %>% 
                      summarise(trips = sum(Count)) %>% spread(Destination_Zone, trips)

  # Total trips
  sum <- trips_by_type %>% summarise(total = sum(trips))
  ee_sum <- trips_by_type %>% summarise(total = sum(ee))
  print(paste("Total trips = ", as.character(sum), sep =""))
  
  # Compute percentage
  trips_by_type <- trips_by_type %>%  mutate(pct_trips = 100 * trips/sum$total, 
                                             pct_ee = 100 * ee/ee_sum$total, 
                                             ee_share = 100 * ee/trips)
  
  trips_by_purpose <- trips_by_purpose %>% mutate(pct_trips = 100 * trips/sum(sum$total), 
                                             pct_ee = 100 * ee/ee_sum$total, 
                                             ee_share = 100 * ee/trips)
  
  trips_by_period <- trips_by_period %>% mutate(pct_trips = 100 * trips/sum(sum$total), 
                                             pct_ee = 100 * ee/ee_sum$total, 
                                             ee_share = 100 * ee/trips)
  
  # Print summary
  kable(trips_by_type)
  kable(trips_by_purpose)
  kable(trips_by_period)
  
```

*** 
## 2. Reading shape data used in the airsage data aggregation.
```{r, echo = TRUE}
# Add project shape files
shape <- readOGR("airsarge_districts/TAZs.shp", layer = "TAZs", verbose = FALSE)

# Read District equivqlency file
taz_dist <- read.table("airsarge_districts/Renumber2.txt", sep = "\t", col.names = c("Dist", "TAZ","pct"))
  
# Compute centroids
shape_polySet <- SpatialPolygons2PolySet(shape)

# Calculate the centroids 
centroids <- calcCentroid(shape_polySet, rollup=1)
shape@data <- cbind(shape@data, centroids)   # Assume internal order matching
```

Some color settings code that is not displayed here. The district numbers shown below are not in sync with Caltran memo, implies the underlying shape file is not the one used in the development of Airsage zones. Need to replace the zone or else the flow data doesn't make much sense.
```{r, echo = FALSE}

# Add  color pallets
pal_hh <- colorNumeric(
  palette = "Blues",
  domain = shape$HHDEN
)

pal_pop <- colorNumeric(
  palette = "Reds",
  domain = shape$POPDEN
)

pal_work <- colorNumeric(
  palette = "Blues",
  domain = shape$WORKDEN
)

pal_emp <- colorNumeric(
  palette = "Reds",
  domain = shape$EMPDEN
)

pal_fact <- colorFactor(topo.colors(6), shape$PlnArea)

m <- leaflet() %>%
  # Base Map
  addProviderTiles("Stamen.Toner",group = "Stamen") %>%
  addTiles(group = "OSM") %>%
  setView(lng = -80.1918, lat = 25.7617, zoom = 10) %>%
  
  # add district shape files
  addTiles %>%
  addPolygons(
    data = shape, group = "Districts", smoothFactor = 0.5,
    stroke = TRUE,  weight = 3, color = "grey",opacity = 0.5,
    fill = TRUE, fillOpacity = 0.5,
    fillColor = ~pal_fact(PlnArea), 
    popup = ~paste(sep = "<br/>",
                   htmlEscape(paste("District = ",as.character(PlnArea),sep="")),
                   htmlEscape(paste("TAZ = ",as.character(TAZ),sep="")),
                   htmlEscape(paste("AREA = ",as.character(SQMILE), sep="")),
                   htmlEscape(paste("Population =", as.character(TOTPOP), sep="")),
                   htmlEscape(paste("Households =", as.character(TOTHH), sep="")),
                   htmlEscape(paste("Workers =", as.character(TOTWORK), sep="")),
                   htmlEscape(paste("Pop density =", as.character(POPDEN), sep="")),
                   htmlEscape(paste("HH density =", as.character(HHDEN), sep="")),
                   htmlEscape(paste("Work density =", as.character(WORKDEN), sep=""))
    )
  ) %>%
   
  # Add district names
  addCircleMarkers(data = shape, lng = shape$X, lat = shape$Y, weight = 1, label = ~as.character(shape$PID), radius = 1, labelOptions = labelOptions(noHide = T))

```

### Review of Airsage data
Add Airsage data to the map and compute:
1. Samples origins and destinations by area
2. Trips origins and destinations by area
3. Trips by prupose (table)
4. Trip flows by purpose (table, d3chord, flowmap)


### Review of Household, Population, Worker and Employment data
The map below displays population, and household and employment densities. 

```{r, echo=FALSE}

map_hhPop <- m %>%
  addPolygons(
    data = shape, group = "HH Density", smoothFactor = 0.5,
    stroke = TRUE,  weight = 3, color = "grey",opacity = 0.5,
    fill = TRUE, fillOpacity = 0.5,
    fillColor = ~pal_hh(HHDEN)
  )  %>%  
  addPolygons(
    data = shape, group = "Pop Density",smoothFactor = 0.5,
    stroke = TRUE,  weight = 3, color = "grey",opacity = 0.5,
    fill = TRUE, fillOpacity = 0.5,
    fillColor = ~pal_pop(POPDEN)
  )  %>%
   
  addLegend(
    "bottomright",pal = pal_hh, values = shape$HHDEN,
     title = "HH Density"
   ) %>%
  
  addLegend(
    "bottomleft",pal = pal_pop, values = shape$POPDEN,
    title = "Pop Density", layerId = 1
  ) %>% 
  
 addLayersControl(
  baseGroups = c("OSM","Stamen"),
  overlayGroups = c("Districts", "HH Density", "Pop Density"),
  options = layersControlOptions(collapsed = FALSE)
 ) %>%

hideGroup(c( "HH Density","Pop Density"))
map_hhPop
```

The map below displays employment and worker densities. THe worker densities are the household workers which is different the employment data.

```{r, echo = FALSE}
map_workEmp <- m %>% 
  
  addPolygons(
    data = shape, group = "Emp Density",smoothFactor = 0.5,
    stroke = TRUE,  weight = 3, color = "grey",opacity = 0.5,
    fill = TRUE, fillOpacity = 0.5,
    fillColor = ~pal_emp(EMPDEN)
  )  %>% 
  
  addPolygons(
    data = shape, group = "Work Density",smoothFactor = 0.5,
    stroke = TRUE,  weight = 3, color = "grey",opacity = 0.5,
    fill = TRUE, fillOpacity = 0.5,
    fillColor = ~pal_work(WORKDEN)
  ) %>% 
  
  addLegend(
    "bottomleft",pal = pal_emp, values = shape$EMPDEN,
    title = "Emp Density", layerId = 2
  ) %>%
  
  addLegend(
    "bottomright",pal = pal_work, values = shape$WORKDEN,
     title = "Work Density"
   ) %>%
  
 addLayersControl(
  baseGroups = c("OSM","Stamen"),
  overlayGroups = c("Districts", "Work Density", "Emp Density"),
  options = layersControlOptions(collapsed = FALSE)
  ) %>% 
  
  hideGroup(c("Work Density", "Emp Density"))
map_workEmp
```





```{r, echo = TRUE}
   
#data_wddp <- read.csv("trip_leg_matrix_cusWDDP.csv")

```


