---
title: "Flagler Data Review"
author: "Amar Sarvepalli"
date: "September 27, 2016"
output: html_document
---
```{r, echo = TRUE}
# User inputs:
projDir         <- "/Users/amarsarvepalli/Desktop/github/Flagler"

# Airsage data files
airsage_data    <- c("airsage/trip_leg_matrix_cusWDH.csv",
                     "airsage/trip_leg_matrix_cusWDDP.csv",
                     "airsage/trip_leg_submatrix_cusWDDP.csv",
                     "airsage/trip_leg_submatrix_cusWDH.csv")
airsage_shapeFile <- "airsage/airsarge_districts/TAZs.shp"
airsage_Districts <- "airsage/airsarge_districts/district_equivalency.csv"

# Define corridor districts
Study_districts <- c(20:40)

# Census ACS data files
acs_shapeFile     <- "acs_data/Tract_2014_Pop_Emp.shp"

# Output files
daily_od_matrix <- "daily_od_trips_by_airsage_districts.csv"
peak_od_matrix <- "peak_od_trips_by_airsage_districts.csv"
daily_od_submatrix <- "daily_od_sub_trips_by_airsage_districts.csv"
peak_od_submatrix <- "peak_od_sub_trips_by_airsage_districts.csv"
```

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# load libraries
library(tidyr)
library(dplyr)
library(knitr)
library(leaflet)
library(rgdal)
library(htmltools)
library(readr)

library(chorddiag)

# Used for computing district centroids
library(maptools)    # SpatialPolygons2PolySet
library(PBSmapping)  # calcCentroid
library(geosphere)

```



```{r custom functions, echo = FALSE}

# function to compute row / column sums
add_marginals <- function(df) {
  df2 <- as.data.frame(df)
  
  cnames <- c(colnames(df), "total")
  rnames <- c(row.names(df),"total")
  
  df2 <- rbind(df2, colSums(df2))  
  df2 <- cbind(df2, rowSums(df2))

  row.names(df2) <- rnames
  colnames(df2) <- cnames
  return(df2) 
}

# function to remove "total" from the matrix
remove_marginals <- function(df){
  df2 <- df %>% select(-total) %>% filter(names(df) != "total")
  return(df2)
}


```



## 1. Review of AirSage Data
This memo is divided into following sections:

1) Airsage Data Files
2) Review of Data: high level summaries
3) Plot of OD zones and corridor
4) Census socio-economic data
5) Plot of current corridor bus routes


#### 1.1 Airsage Data File Description
This is airsage data review. The following is the description of the data files

1) **trip_leg_matrix_cusWDH.csv**  and **trip_leg_matrix_cusWDDP.csv**: reporting  trips between study area zones for average weekday 24 hour period and specific AM and PM day parts respectively.

2) **trip_leg_submatrix_cusWDH.csv**  and **trip_leg_submatrix_cusWDDP.csv**: reporting trips between study area zones that passed through the sub matrix analysis zone (in the SZCount column) for average weekday 24 hour period and specific AM and PM day parts respectively. 

The following are the list of files received from Airsage along with:
1) number of samples
2) number of trips
3) ratio of trips to samples
4) percent of samples
5) percent of trips

```{r read data, echo=FALSE, message=FALSE, warning=FALSE}
  csvFiles <- dir(paste(projDir,"/airsage",sep=""), pattern = ".csv")

  for (c in 1:length(csvFiles)){
    data <- read.csv(paste0("airsage/",csvFiles[c]))
    nrows <- nrow(data)
    ntrips <- sum(data$Count)
    samples <- cbind(csvFiles[c], nrows, ntrips)
    ifelse (c ==1 , all_samples <- samples, all_samples <- rbind(all_samples, samples))
    ifelse (c ==1 , count <- nrows, count <- count + nrows)
    ifelse (c ==1 , trips <- ntrips, trips <- trips + ntrips)
  }

    all <- data.frame(all_samples, stringsAsFactors = FALSE)
    all <- rbind(all, c("Total",count, trips))
    all <- all %>% mutate(trip_per_sample = 100 * as.numeric(ntrips) / as.numeric(nrows))
    all <- all %>% mutate(pct_samples = 100 * as.numeric(nrows) / count)
    all <- all %>% mutate(pct_trips = 100 * as.numeric(ntrips) / trips)
    names(all) <- c("File", "Samples", "Trips","Trips/Samples" ,"% Sample", "% Trips")
    print(kable(all,format.args = list(big.mark = ","), digits = 0))
  
```

Peak data flow shows a total observations of 9,666 whereas total daily flows are only 6,052.
Does this mean the daily samples are only for offpeak? 
46% of the daily flow are represented from 24% sample?


#### 1.2 Contents of "trip_leg_matrix_cusWDDP.csv" and Contents of "trip_leg_matrix_cusWDDP.csv"
This file contains 9,666 observations and 9 fields. Each sample was geocoded with an _Origin_Zone_ and _Destination_Zone_ pairs and _Count_ represents the total flows betweent these OD pairs. The start and end dates define the data collection period, which is April, 2015. The other fields: _Subscriber_Class_, _Purpose_ and _Time_of_Day_ describe the trip attributes.

```{r daily & peak trips, echo=TRUE, message=FALSE, warning=FALSE}
  data_wddp <- read.csv("airsage/trip_leg_matrix_cusWDDP.csv")
  data_wdh <- read.csv("airsage/trip_leg_matrix_cusWDH.csv")
  data_wddp$tod <- "peak"
  data_wdh$tod <- "24H"
  data <- rbind(data_wddp, data_wdh)
  print(head(data))
```

Total trips from both files are shown below. 
```{r total trips, echo=TRUE, message=FALSE, warning=FALSE}
    
  # Total trips
  total_trips <- data %>% group_by(tod) %>% summarize(sum = sum(Count))
  kable(total_trips,format.args = list(big.mark = ","), digits = 0)
```

The daily file contains more aggregated data with periods combined and thus the number of samples are fewer compared to AM/PM files. However, the total number of trips reveal that daily includes AM/PM trips although this needs to be confirmed from Airsage. 

```{r trips by purpose, echo=TRUE, message=FALSE, warning=FALSE}
  # Break down by purpose and period
  samples <- data %>% group_by(tod, Purpose, Time_of_Day) %>% tally
  trips <- data %>% group_by(tod, Purpose, Time_of_Day) %>% summarize(sum = sum(Count))
  kable(left_join(samples,trips, by = c("Purpose" , "Time_of_Day", "tod")),format.args = list(big.mark = ","), digits = 0)
  
```

#### 1.3 Contents of Daily file (_trip_leg_matrix_cusWDH.csv_)
#### Trips by purpose and resident type (Subscriber_Class)
* There are a total of 7,457,084 OD flows in 24H. 
* About 83% of these trips (6.2 Million daily flows) are made by resident pouplation and the remaining 17% of trip are made by the visitors. 
* Most of the visitor trip purpose was Non-home based (NHB) as expected, however there are few handful of trips that are coded as Home-based other (HBO) trips (0.03%). These trips can be recoded into NHB as it makes less sense to assume a "home end" for visitors.
* Of 6.2 Million resident trips, 17% are Home-based work (HBW), 29% are NHB and 36% are HBO trips. The work share of trips is in acceptable range for HBW trips (typically ~20%).


```{r daily trips, echo=FALSE, message=FALSE, warning=FALSE}

  trips_by_type    <- data_wdh %>% group_by(Subscriber_Class) %>% 
                      summarise(trips = sum(Count)) %>% arrange(Subscriber_Class)
  trips_by_purpose <- data_wdh %>% group_by(Subscriber_Class, Purpose) %>% 
                      summarise(trips = sum(Count)) %>% arrange(Subscriber_Class)
  trips_by_OD      <- data_wdh %>% group_by(Origin_Zone, Destination_Zone) %>% 
                      summarise(trips = sum(Count)) %>% spread(Destination_Zone, trips)

  # Total trips  
  sum <- trips_by_type %>% summarise(total = sum(trips))
  print(paste("Total trips = ", as.character(sum), sep =""))
  
  # Compute percentage
  trips_by_type    <- trips_by_type %>%  mutate(percent = 100 * trips/sum$total)
  trips_by_purpose <- trips_by_purpose %>% mutate(percent = 100 * trips/sum(sum$total))
  
  # Print summary
  kable(trips_by_type,format.args = list(big.mark = ","), digits = 0)
  kable(trips_by_purpose,format.args = list(big.mark = ","), digits = 0)
  
  # District to district flows (limit this to Flagler districts)
  trips_by_OD <- trips_by_OD[,2:41]
  trips_by_OD[is.na(trips_by_OD)] <- 0
  
  # Write output
  write.csv(trips_by_OD, daily_od_matrix, row.names = FALSE)
  
```

#### 1.4 Contents of Peak period files (_trip_leg_matrix_cusWDDP.csv_)
#### Trips by purpose, resident type (Subscriber_Class) and time of day
* There are a total of 2,945,178 OD flows in the peak two periods. 
* About 85% of these trips (2.5 Million flows) are made by resident pouplation and the remaining 15% of trip are made by the visitors. 
* Most of the visitor trip purpose was Non-home based (NHB) as expected, however there are few handful of trips that are coded as Home-based other (HBO) trips (0.02%). These trips can be recoded into NHB as it makes less sense to assume a "home end" for visitors.
* Of 2.5 Million resident trips, 21% are Home-based work (HBW), 29% are NHB and 34% are HBO trips. The non-work share of trips seems too high given this file contains data only for the 6 hour peak periods.
* Trips by time of day shows almost equal split between AM and PM peak periods with slightly more trips in PM period.

```{r, echo = FALSE}
  trips_by_type    <- data_wddp %>% group_by(Subscriber_Class) %>% 
                      summarise(trips = sum(Count)) %>% arrange(Subscriber_Class)
  trips_by_purpose <- data_wddp %>% group_by(Subscriber_Class, Purpose) %>% 
                      summarise(trips = sum(Count)) %>% arrange(Subscriber_Class)
  trips_by_period  <- data_wddp %>% group_by(Time_of_Day) %>% 
                      summarise(trips = sum(Count)) %>% arrange(Time_of_Day)
  trips_by_OD      <- data_wddp %>% group_by(Origin_Zone, Destination_Zone) %>% 
                      summarise(trips = sum(Count)) %>% spread(Destination_Zone, trips)

  # Total trips
  sum <- trips_by_type %>% summarise(total = sum(trips))
  print(paste("Total trips = ", as.character(sum), sep =""))
  
  # Compute percentage
  trips_by_type    <- trips_by_type %>%  mutate(percent = 100 * trips/sum$total)
  trips_by_purpose <- trips_by_purpose %>% mutate(percent = 100 * trips/sum(sum$total))
  trips_by_period  <- trips_by_period %>% mutate(percent = 100 * trips/sum(sum$total))
  
  # Print summary
  kable(trips_by_type,format.args = list(big.mark = ","), digits = 0)
  kable(trips_by_purpose,format.args = list(big.mark = ","), digits = 0)
  kable(trips_by_period,format.args = list(big.mark = ","), digits = 0)
  
  write.csv(trips_by_OD, peak_od_matrix, row.names = FALSE)
  
  # District to district flows (limit this to Flagler districts)
  # trips_by_OD <- trips_by_OD[,2:41]
  # trips_by_OD[is.na(trips_by_OD)] <- 0
  # m <- as.matrix(trips_by_OD)
  # dist <- c(1:40)
  # dimnames(m) <- list(Origins = dist,Destinations = dist)
  # groupColors <- colors()[dist]
  # chorddiag(m, groupColors = groupColors, groupnamePadding = 20)

```

#### 1.5 Airsage districts
The airsage data was provided for about 40 districts as shown in the below interactive map. 

```{r, echo = TRUE}

# Add airsage district file
shape <- readOGR(airsage_shapeFile, layer = "TAZs", verbose = FALSE)

# Read District equivqlency file
taz_dist <- read.csv(airsage_Districts)

# Append districts to 40 Zones
shape@data <- left_join(shape@data, taz_dist, by = "TAZ")

```


```{r, echo = FALSE}
# Compute centroids
shape_polySet <- SpatialPolygons2PolySet(shape)

# Calculate the centroids 
centroids <- calcCentroid(shape_polySet, rollup=1)
shape@data <- cbind(shape@data, centroids)   # Assume internal order matching

# Add  color pallets
pal_hh <- colorNumeric(
  palette = "Blues",
  domain = shape$HHDEN
)

pal_pop <- colorNumeric(
  palette = "Reds",
  domain = shape$POPDEN
)

pal_work <- colorNumeric(
  palette = "Blues",
  domain = shape$WORKDEN
)

pal_emp <- colorNumeric(
  palette = "Reds",
  domain = shape$EMPDEN
)

pal_fact <- colorFactor(topo.colors(6), shape$PlnArea)

map <- leaflet() %>%
  # Base Map
  addProviderTiles("Stamen.Toner",group = "Stamen") %>%
  addTiles(group = "OSM") %>%
  setView(lng = -80.1918, lat = 25.7617, zoom = 10) %>%
  
  # add district shape files
  addTiles %>%
    addPolygons(
    data = shape, group = "Dist Polyline", smoothFactor = 0.5,
    stroke = TRUE,  weight = 3, color = "grey",opacity = 0.5,
    fill = FALSE) %>%
  addPolygons(
    data = shape, group = "Districts", smoothFactor = 0.5,
    stroke = TRUE,  weight = 3, color = "grey",opacity = 0.5,
    fill = TRUE, fillOpacity = 0.5,
    fillColor = ~pal_fact(PlnArea)
    # popup = ~paste(sep = "<br/>",
    #                htmlEscape(paste("District = ",as.character(PlnArea),sep="")),
    #                htmlEscape(paste("TAZ = ",as.character(TAZ),sep="")),
    #                htmlEscape(paste("AREA = ",as.character(SQMILE), sep="")),
    #                htmlEscape(paste("Population =", as.character(TOTPOP), sep="")),
    #                htmlEscape(paste("Households =", as.character(TOTHH), sep="")),
    #                htmlEscape(paste("Workers =", as.character(TOTWORK), sep="")),
    #                htmlEscape(paste("Pop density =", as.character(POPDEN), sep="")),
    #                htmlEscape(paste("HH density =", as.character(HHDEN), sep="")),
    #                htmlEscape(paste("Work density =", as.character(WORKDEN), sep=""))
    # )
  ) %>%
   
  # Add district names
  addCircleMarkers(data = shape, lng = shape$X, lat = shape$Y, weight = 1, label =   ~as.character(shape$Districts), radius = 1, labelOptions = labelOptions(noHide = T),  group = "Districts")

map

```

#### 1.6 Study Area Flows
Districts 20 - 40 represent Flagler Corridor study area.  The entire study area was defined as one super district "StudyArea" and the rest of the districts as "Outside" super district. The OD matrix generated for this super districts list the External-External (EE), Internal_External (IE), External_Internal (EI) and Internal-Internal (II) trips to the study area. The study area serves about 11% of the daily trips in the Miami-Dade county (sum of IE, EI and II trips). 

####Daily Study Area Flows
Tables below show the daily OD flows.

```{r study_area_daily, echo=FALSE}
  
  # 1. Create Daily flagler matrix (II, EI/IE, EE through Flagler districts)
  study_wdh <- data_wdh %>% mutate(
                      study_Os = ifelse (Origin_Zone %in% Study_districts, "StudyArea", "Outside"),
                      study_Ds = ifelse (Destination_Zone %in% Study_districts, "StudyArea", "Outside")
                      )
  trips_by_OD      <- study_wdh %>% group_by(study_Os, study_Ds) %>% 
                      summarise(trips = sum(Count)) %>% spread(study_Ds, trips) %>% 
                      as.data.frame() %>% select(-study_Os) %>% add_marginals()
  
  row.names(trips_by_OD) <- colnames(trips_by_OD)
  kable(trips_by_OD,format.args = list(big.mark = ","), digits = 0)
  
  pct_trips_by_OD <- 100 * trips_by_OD / trips_by_OD["total","total"]
  kable(pct_trips_by_OD,format.args = list(big.mark = ","), digits = 2)
  
  # 2. Create Daily flagler matrix to other districts  
  study_wdh <- data_wdh %>% mutate(
                      study_Os = ifelse (Origin_Zone %in% Study_districts, 
                                         min(Study_districts), Origin_Zone
                                         ),
                      study_Ds = ifelse (Destination_Zone %in% Study_districts, 
                                         min(Study_districts), Destination_Zone
                                         )
                      )
  
  trips_by_OD      <- study_wdh %>% group_by(study_Os, study_Ds) %>% 
                      summarise(trips = sum(Count)) %>% spread(study_Ds, trips) %>%
                      as.data.frame() %>% select(-study_Os) %>% add_marginals()
  # Write output
  write.csv(trips_by_OD, daily_od_submatrix, row.names = FALSE)
  
  # Compute to & from Study Area flows (& pct flows)
  study_origins <- trips_by_OD %>% filter(row.names(trips_by_OD) == "20")
  study_origins_pct <- 100 * study_origins / study_origins$total
  study_destination <- trips_by_OD %>% select(20) %>% t() %>% as.data.frame()
  study_destination_pct <- 100 * study_destination / study_destination$total
  studyarea_flows <- bind_rows(study_origins, study_origins_pct, study_destination, study_destination_pct) %>% t() %>% as.data.frame
  colnames(studyarea_flows) <- c("Origins", "Origin_Pct", "Destination", "Dest_Pct")
  kable(studyarea_flows,format.args = list(big.mark = ","), digits = 2)
  
  # generate chord diagram  
  df <- remove_marginals(trips_by_OD)
  m <- as.matrix(df)
  dimnames(m) <- list(Origins = row.names(df), Destinations = row.names(df))
  groupColors <-  colorRampPalette(c("blue", "red", "green"))(20) 
  chorddiag(m, groupColors = groupColors, groupnamePadding = 20, showTicks = FALSE)
``` 

Plot of total daily Origins and Destinations to/from Study Area.

```{r, echo = FALSE}    
  # Plot desire lines
  trips_by_OD <- trips_by_OD %>% 
                 remove_marginals() %>% 
                 gather() %>% 
                 mutate(To = rep(c(1:20),20)) %>% 
                 rename(From = key) 
  trips_by_OD$From <- as.integer(trips_by_OD$From)
  
  dist_cords <- shape@data %>% filter(Districts < 21) %>% select(Districts, X, Y)
  
  from_Study <- trips_by_OD %>% 
                  left_join(dist_cords, by = c("From" = "Districts")) %>%
                  rename(fromlong = X, fromlat = Y) %>%
                  left_join(dist_cords, by = c("To" = "Districts")) %>%
                  rename(tolong = X, tolat = Y) %>%
                  filter(From == 20) 
  
  from_flows <- gcIntermediate(
  p1 = select(from_Study, fromlong:fromlat),
  p2 = select(from_Study, tolong:tolat),
  sp = TRUE,
  addStartEnd = TRUE
  )
  from_flows <- SpatialLinesDataFrame(from_flows, from_Study)

  to_Study <- trips_by_OD %>% 
                  left_join(dist_cords, by = c("From" = "Districts")) %>%
                  rename(fromlong = X, fromlat = Y) %>%
                  left_join(dist_cords, by = c("To" = "Districts")) %>%
                  rename(tolong = X, tolat = Y) %>%
                  filter(To == 20) %>%
                  mutate(pct = 100 * value/sum(value))
  
  to_flows <- gcIntermediate(
              p1 = select(to_Study, fromlong:fromlat),
              p2 = select(to_Study, tolong:tolat),
              sp = TRUE,
              addStartEnd = TRUE
            )
  
  to_flows <- SpatialLinesDataFrame(to_flows, to_Study)

  
  map %>%
  addPolylines(
    data = from_flows,
    group = "Origins",
    weight = ~ value/ 10000,
    color = "red",
    popup = ~paste0("Origins Trips: ", value)
  ) %>%
  addCircleMarkers(
    data = from_flows, 
    lng = from_flows$tolong, lat = from_flows$tolat, weight = 1, 
    label = ~as.character(format(round(from_flows$value,0), big.mark = ",")),
    radius = 1,
    labelOptions = labelOptions(noHide = T),
    group = "Origins"
  ) %>%
  addPolylines(
    data = to_flows,
    group = "Destinations",
    weight = ~ value/ 10000,
    color = "blue",
    popup = ~paste0("Destinations Trips: ", value)
  ) %>%
  addCircleMarkers(
    data = to_flows, 
    lng = to_flows$fromlong, lat = to_flows$fromlat, weight = 1, 
    label =   ~as.character(format(round(to_flows$value,0), big.mark = ",")), radius = 1, 
    labelOptions = labelOptions(noHide = T),  
    group = "Destinations"
  ) %>%
  addLayersControl(
        baseGroups = c("OSM","Stamen"),
        overlayGroups = c("Districts","Origins", "Destinations"),
        options = layersControlOptions(collapsed = FALSE)
  ) %>%
  hideGroup(c("Districts", "Destinations"))

```

####Peak Study Area Flows
The following are the tables showing the peak trips
```{r study_area_peak, echo=FALSE}  
  # 3. Create Peak flagler matrix (II, EI/IE, EE through Flagler districts)
  study_wddp <- data_wddp %>% mutate(
                      study_Os = ifelse (Origin_Zone %in% Study_districts, "StudyArea", "Outside"),
                      study_Ds = ifelse (Destination_Zone %in% Study_districts, "StudyArea", "Outside")
                      )
  trips_by_OD      <- study_wddp %>% group_by(study_Os, study_Ds) %>% 
                      summarise(trips = sum(Count)) %>% spread(study_Ds, trips) %>% 
                      as.data.frame() %>% select(-study_Os) %>% add_marginals()
  
  row.names(trips_by_OD) <- colnames(trips_by_OD)
  kable(trips_by_OD,format.args = list(big.mark = ","), digits = 0)
  
  pct_trips_by_OD <- 100 * trips_by_OD / trips_by_OD["total","total"]
  kable(pct_trips_by_OD,format.args = list(big.mark = ","), digits = 2)
  
  # 4. Create Peak flagler matrix to other districts  
  study_wdh <- data_wdh %>% mutate(
                      study_Os = ifelse (Origin_Zone %in% Study_districts, 
                                         min(Study_districts), Origin_Zone
                                         ),
                      study_Ds = ifelse (Destination_Zone %in% Study_districts, 
                                         min(Study_districts), Destination_Zone
                                         )
                      )
  
  trips_by_OD      <- study_wdh %>% group_by(study_Os, study_Ds) %>% 
                      summarise(trips = sum(Count)) %>% spread(study_Ds, trips) %>%
                      as.data.frame() %>% select(-study_Os) %>% add_marginals()
  
  row.names(trips_by_OD) <- colnames(trips_by_OD)
  pct_trips_by_OD <- 100 * trips_by_OD / trips_by_OD["total","total"]
  print("Percent of Peak Trips")
  kable(pct_trips_by_OD,format.args = list(big.mark = ","), digits = 2)
  
  # Write output
  write.csv(trips_by_OD, peak_od_submatrix, row.names = FALSE)
  
  # produce chord diagram  
  df <- remove_marginals(trips_by_OD)
  m <- as.matrix(df)
  dimnames(m) <- list(Origins = row.names(df), Destinations = row.names(df))
  groupColors <-  colorRampPalette(c("blue", "red", "green"))(20) 
  chorddiag(m, groupColors = groupColors, groupnamePadding = 20, showTicks = FALSE)
  
```

Inorder to better understand the travel patterns through the corridor, OD tables are developed to & from the studyarea super district to all other districts, where district 20 is the aggregated study area district.


#### 1.7 Contents of Peak subarea files (_trip_leg_submatrix_cusWDDP.csv_)
#### Trips by purpose, resident type (Subscriber_Class) and time of day
* There are a total of 1,472,307 OD flows in this file which represent EE flows through the region (Not sure I fully flow this file - Need some explaination from Airsage)
* About 83% of these trips (1.2 Million flows) are made by resident pouplation and the remaining 17% of trip are made by the visitors. 
* 10% of these trips are External-External through trips (ee). This is computed based on _SZCount_ field in the data.
* The share of ee trips by purpose is consistent across all resident purposes and time of day.
* Most of the visitor trip purpose was Non-home based (NHB) as expected.


```{r sub_ee_peak, echo=FALSE}
  sub_wddp <- read.csv("airsage/trip_leg_submatrix_cusWDDP.csv")
  trips_by_type    <- sub_wddp %>% group_by(Subscriber_Class) %>% 
                      summarise(trips = sum(Count), ee = sum(SZCount)) %>% arrange(Subscriber_Class)
  trips_by_purpose <- sub_wddp %>% group_by(Subscriber_Class, Purpose) %>% 
                      summarise(trips = sum(Count), ee = sum(SZCount)) %>% arrange(Subscriber_Class)
  trips_by_period  <- sub_wddp %>% group_by(Time_of_Day) %>% 
                      summarise(trips = sum(Count), ee = sum(SZCount)) %>% arrange(Time_of_Day)
  trips_by_OD      <- sub_wddp %>% group_by(Origin_Zone, Destination_Zone) %>% 
                      summarise(trips = sum(Count)) %>% spread(Destination_Zone, trips)

  # Total trips
  sum <- trips_by_type %>% summarise(total = sum(trips))
  ee_sum <- trips_by_type %>% summarise(total = sum(ee))
  print(paste("Total trips = ", as.character(sum), sep =""))
  
  # Compute percentage
  trips_by_type <- trips_by_type %>%  mutate(pct_trips = 100 * trips/sum$total, 
                                             pct_ee = 100 * ee/ee_sum$total, 
                                             ee_share = 100 * ee/trips)
  
  trips_by_purpose <- trips_by_purpose %>% mutate(pct_trips = 100 * trips/sum(sum$total), 
                                             pct_ee = 100 * ee/ee_sum$total, 
                                             ee_share = 100 * ee/trips)
  
  trips_by_period <- trips_by_period %>% mutate(pct_trips = 100 * trips/sum(sum$total), 
                                             pct_ee = 100 * ee/ee_sum$total, 
                                             ee_share = 100 * ee/trips)
  
  # Print summary
  kable(trips_by_type)
  kable(trips_by_purpose)
  kable(trips_by_period)
  
```


#### 1.8 Contents of Peak subarea files (_trip_leg_submatrix_cusWDH.csv_)
#### Trips by purpose, and resident type (Subscriber_Class) 
* There are a total of 4,001,471 OD flows in this file which represent EE flows through the region (Not sure I fully flow this file - Need some explaination from Airsage)
* About 80% of these trips (2.9 Million flows) are made by resident pouplation and the remaining 20% of trip are made by the visitors. 
* About 9% of these trips are External-External through trips (ee). This is computed based on _SZCount_ field in the data.
* The share of ee trips by purpose is consistent across all resident purposes and time of day.
* Most of the visitor trip purpose was Non-home based (NHB) as expected.


```{r sub_ee_daily, echo=FALSE}
  sub_wdh <- read.csv("airsage/trip_leg_submatrix_cusWDH.csv")

  # fix colnames for purpose and time_of_day
  sub_wdh <- sub_wdh %>% rename(Purpose = Time_of_Day, Time_of_Day = Purpose)

  trips_by_type    <- sub_wdh %>% group_by(Subscriber_Class) %>% 
                      summarise(trips = sum(Count), ee = sum(SZCount)) %>% arrange(Subscriber_Class)
  trips_by_purpose <- sub_wdh %>% group_by(Subscriber_Class, Purpose) %>% 
                      summarise(trips = sum(Count), ee = sum(SZCount)) %>% arrange(Subscriber_Class)
  trips_by_period  <- sub_wdh %>% group_by(Time_of_Day) %>% 
                      summarise(trips = sum(Count), ee = sum(SZCount)) %>% arrange(Time_of_Day)
  trips_by_OD      <- sub_wdh %>% group_by(Origin_Zone, Destination_Zone) %>% 
                      summarise(trips = sum(Count)) %>% spread(Destination_Zone, trips)

  # Total trips
  sum <- trips_by_type %>% summarise(total = sum(trips))
  ee_sum <- trips_by_type %>% summarise(total = sum(ee))
  print(paste("Total trips = ", as.character(sum), sep =""))
  
  # Compute percentage
  trips_by_type <- trips_by_type %>%  mutate(pct_trips = 100 * trips/sum$total, 
                                             pct_ee = 100 * ee/ee_sum$total, 
                                             ee_share = 100 * ee/trips)
  
  trips_by_purpose <- trips_by_purpose %>% mutate(pct_trips = 100 * trips/sum(sum$total), 
                                             pct_ee = 100 * ee/ee_sum$total, 
                                             ee_share = 100 * ee/trips)
  
  trips_by_period <- trips_by_period %>% mutate(pct_trips = 100 * trips/sum(sum$total), 
                                             pct_ee = 100 * ee/ee_sum$total, 
                                             ee_share = 100 * ee/trips)
  
  # Print summary
  kable(trips_by_type)
  kable(trips_by_purpose)
  kable(trips_by_period)
  
```

*** 
## 2. Review of Airsage data
Add Airsage data to the map and compute:
  1. Samples origins and destinations by distrcits
  2. Trips origins and destinations by area
  3. Trips by prupose (table)
  4. Trip flows by purpose (table, d3chord, flowmap)

```{r process airsage, echo=FALSE} 
    ods <- left_join(data_wddp %>% group_by(Origin_Zone) %>% summarise(O_wddp = sum(Count)),
                     data_wdh %>% group_by(Origin_Zone) %>% summarise(O_wdh = sum(Count)),
                     by = "Origin_Zone") %>% 
               left_join(sub_wddp %>% group_by(Origin_Zone) %>% summarise(O_swddp = sum(Count)),
                         by = "Origin_Zone") %>% 
               left_join(sub_wdh %>% group_by(Origin_Zone) %>% summarise(O_sdh = sum(Count)),
                         by = "Origin_Zone") %>%
               left_join(data_wddp %>% group_by(Destination_Zone) %>% summarise(D_wddp = sum(Count)),
                         by = c("Origin_Zone" = "Destination_Zone")) %>% 
               left_join(data_wdh %>% group_by(Destination_Zone) %>% summarise(D_wdh = sum(Count)),
                         by = c("Origin_Zone" = "Destination_Zone")) %>%
               left_join(sub_wddp %>% group_by(Destination_Zone) %>% summarise(D_swddp = sum(Count)),
                         by = c("Origin_Zone" = "Destination_Zone")) %>%
               left_join(sub_wdh %>% group_by(Destination_Zone) %>% summarise(D_sdh = sum(Count)),
                         by = c("Origin_Zone" = "Destination_Zone"))
   ods <- rename(ods, Districts = Origin_Zone)

   shape@data <- left_join(shape@data, ods, by = "Districts")
        
# Color pallate to cover all values in the OD data
min_max <- c(do.call(pmin, ods[2:ncol(ods)]),do.call(pmax, ods[2:ncol(ods)]))
pal_ods <- colorNumeric(
  palette = "Blues",
  domain = min_max
)

map_ODs <- map %>%
 # Peak origins  
 addPolygons(
    data = shape, group = "O_peak",smoothFactor = 0.5,
    stroke = TRUE,  weight = 3, color = "grey",opacity = 0.5,
    fill = TRUE, fillOpacity = 0.5,
    fillColor = ~pal_ods(O_wddp),
     popup = ~paste(sep = "<br/>",
                    htmlEscape(paste("Peak Origins = ",as.character(round(O_wddp,0)),sep="")))
  ) %>%

  # Daily origins
  addPolygons(
    data = shape, group = "O_daily",smoothFactor = 0.5,
    stroke = TRUE,  weight = 3, color = "grey",opacity = 0.5,
    fill = TRUE, fillOpacity = 0.5,
    fillColor = ~pal_ods(O_wdh),
    popup = ~paste(sep = "<br/>",
                    htmlEscape(paste("Daily Origins = ",as.character(round(O_wdh,0)),sep="")))
  )  %>%
  # Peak Destinations
  addPolygons(
    data = shape, group = "D_peak",smoothFactor = 0.5,
    stroke = TRUE,  weight = 3, color = "grey",opacity = 0.5,
    fill = TRUE, fillOpacity = 0.5,
    fillColor = ~pal_ods(D_wddp),
        popup = ~paste(sep = "<br/>",
                    htmlEscape(paste("Peak Destinations = ",as.character(round(D_wddp,0)),sep="")))
  )  %>%
  # Daily Destinations
  addPolygons(
    data = shape, group = "D_daily",smoothFactor = 0.5,
    stroke = TRUE,  weight = 3, color = "grey",opacity = 0.5,
    fill = TRUE, fillOpacity = 0.5,
    fillColor = ~pal_ods(D_wdh),
        popup = ~paste(sep = "<br/>",
                    htmlEscape(paste("Daily Destinations = ",as.character(round(D_wdh,0)),sep="")))
  ) %>%

  addLegend(
    "bottomleft",pal = pal_ods, values = min_max,
     title = "Counts"
   ) %>%
  addLayersControl(
        baseGroups = c("OSM","Stamen"),
        overlayGroups = c("Districts","O_peak", "O_daily", "D_peak", "D_daily"),
        options = layersControlOptions(collapsed = FALSE)
  ) %>%

  hideGroup(c("O_peak", "O_daily", "D_peak", "D_daily"))

map_ODs

```


*** 
## 3. Review of Census data
### Review of Household, Population, Worker and Employment data
The map below displays population, and household and employment densities. 

```{r, echo=FALSE}

map_hhPop <- map %>%
  addPolygons(
    data = shape, group = "HH Density", smoothFactor = 0.5,
    stroke = TRUE,  weight = 3, color = "grey",opacity = 0.5,
    fill = TRUE, fillOpacity = 0.5,
    fillColor = ~pal_hh(HHDEN)
  )  %>%  
  addPolygons(
    data = shape, group = "Pop Density",smoothFactor = 0.5,
    stroke = TRUE,  weight = 3, color = "grey",opacity = 0.5,
    fill = TRUE, fillOpacity = 0.5,
    fillColor = ~pal_pop(POPDEN)
  )  %>%
   
  addLegend(
    "bottomright",pal = pal_hh, values = shape$HHDEN,
     title = "HH Density"
   ) %>%
  
  addLegend(
    "bottomleft",pal = pal_pop, values = shape$POPDEN,
    title = "Pop Density", layerId = 1
  ) %>% 
  
 addLayersControl(
  baseGroups = c("OSM","Stamen"),
  overlayGroups = c("Districts", "HH Density", "Pop Density"),
  options = layersControlOptions(collapsed = FALSE)
 ) %>%

hideGroup(c( "HH Density","Pop Density"))
map_hhPop
```

The map below displays employment and worker densities. THe worker densities are the household workers which is different the employment data.

```{r, echo = FALSE}
map_workEmp <- map %>% 
  
  addPolygons(
    data = shape, group = "Emp Density",smoothFactor = 0.5,
    stroke = TRUE,  weight = 3, color = "grey",opacity = 0.5,
    fill = TRUE, fillOpacity = 0.5,
    fillColor = ~pal_emp(EMPDEN)
  )  %>% 
  
  addPolygons(
    data = shape, group = "Work Density",smoothFactor = 0.5,
    stroke = TRUE,  weight = 3, color = "grey",opacity = 0.5,
    fill = TRUE, fillOpacity = 0.5,
    fillColor = ~pal_work(WORKDEN)
  ) %>% 
  
  addLegend(
    "bottomleft",pal = pal_emp, values = shape$EMPDEN,
    title = "Emp Density", layerId = 2
  ) %>%
  
  addLegend(
    "bottomright",pal = pal_work, values = shape$WORKDEN,
     title = "Work Density"
   ) %>%
  
 addLayersControl(
  baseGroups = c("OSM","Stamen"),
  overlayGroups = c("Districts", "Work Density", "Emp Density"),
  options = layersControlOptions(collapsed = FALSE)
  ) %>% 
  
  hideGroup(c("Work Density", "Emp Density"))
map_workEmp
```

### 3. Read Miami Dade Zones
<!-- # ```{r, echo = TRUE} -->
<!-- # # Get layer name from shape file -->
<!-- # mdc_ShapeFile <- paste0(projDir,"/airsage_zones/MDC_Taz.shp") -->
<!-- # layerName <- strsplit(strsplit(mdc_ShapeFile,"[.]")[[1]],"/")[[1]][2] -->
<!-- # # Add census shape files -->
<!-- # mdcShape <- readOGR(mdc_ShapeFile, layer = layerName, verbose = FALSE) -->
<!-- # -->
<!-- # map <- leaflet() %>% -->
<!-- #   # Base Map -->
<!-- #   addProviderTiles("Stamen.Toner",group = "Stamen") %>% -->
<!-- #   addTiles(group = "OSM") %>% -->
<!-- #   setView(lng = -80.1918, lat = 25.7617, zoom = 10) %>% -->
<!-- #   addTiles %>% -->
<!-- #   addPolygons(data = mdcShape, group = "tracts") -->
<!-- # -->
<!-- # map -->
<!-- # ``` -->


***

### 3. Read Census ACS Data for 2014
```{r, echo = TRUE}

# Get layer name from shape file
layerName <- strsplit(strsplit(acs_shapeFile,"[.]")[[1]],"/")[[1]][2]
# Add census shape files
acsShape <- readOGR(paste0(projDir,"/",acs_shapeFile), layer = layerName, verbose = FALSE)

map <- leaflet() %>%
  # Base Map
  addProviderTiles("Stamen.Toner",group = "Stamen") %>%
  addTiles(group = "OSM") %>%
  setView(lng = -80.1918, lat = 25.7617, zoom = 10) %>%
  addTiles %>%
  addPolygons(data = acsShape, group = "acs_data")
    
map
```


